---
name: harness-check
description: |
  ハーネス（スモークテスト＋構造チェック）を実行し、失敗時は自動修正またはハーネス強化を提案する。
  トリガー: "harness-check", "ハーネス確認", "ハーネス実行", "スモークテスト", "構造チェック"
user-invocable: true
allowed-tools: Bash, Read, Edit, Write, Glob, Grep
---

# ハーネスチェック実行

スモークテストと構造チェックを実行し、結果に応じて自動修正 or ハーネス強化を提案する。

## 処理フロー

### Step 1: 対象プロジェクトの特定

引数で指定されていればそれを使う。なければ質問する。
スクリプトの存在を確認する:

```bash
ls <project_dir>/scripts/smoke-test.sh <project_dir>/scripts/structure-check.sh
```

存在しない場合は `/harness-init` の実行を案内して終了する。

### Step 2: スモークテスト実行

2分タイムアウトで実行:

```bash
cd <project_dir> && timeout 120 ./scripts/smoke-test.sh
```

実行結果と終了コードを記録する。

### Step 3: 構造チェック実行

```bash
cd <project_dir> && ./scripts/structure-check.sh
```

実行結果と終了コードを記録する。

### Step 4: 結果判定と対応

#### 全パスの場合

```
## ✅ ハーネスチェック結果

### 🔥 Smoke Test
✅ All N tests passed

### 🏗️ Structure Check
✅ All N checks passed

すべてのチェックをパスしました。
```

#### 失敗ありの場合

失敗内容を分析し、ユーザーに2択を提示する:

```
## ❌ ハーネスチェック結果

### 🔥 Smoke Test
❌ N/M tests failed:
- <失敗したテスト名>

### 🏗️ Structure Check
❌ N/M checks failed:
- <失敗したチェック名>

### 失敗の分析
<失敗原因の簡潔な分析>

### 対応方針を選んでください

**A) コード側を修正して再テスト**
→ コードにバグや問題がある場合。エージェントが自動修正を試みます。

**B) ハーネスを強化（`/harness-strengthen`）**
→ テストやルールの方が不適切・不足している場合。ハーネス側を改善します。
```

### Step 5: 自動修正（Aを選んだ場合）

1. 失敗したテストのエラー内容を詳細に分析
2. 関連するソースコードを読み込み
3. 修正を実施
4. 再度スモークテスト + 構造チェックを実行
5. パスするまで繰り返す（最大3回）

3回試行しても失敗する場合は、ハーネス強化（B）を推奨する。

```
⚠️ 3回の自動修正で解決しませんでした。
ハーネス側の見直しが必要かもしれません。
`/harness-strengthen` でハーネスを強化することを検討してください。
```

### Step 6: 修正後の最終報告

```
## 🔄 修正完了

### 変更内容
- <修正したファイルと内容の概要>

### 再テスト結果
✅ All tests passed

### 修正サマリー
<何が問題で、どう修正したかの簡潔な説明>
```

## 注意事項

- スモークテストのタイムアウトは120秒（2分）を厳守
- 自動修正はコードの意図を変えない範囲で行う
- 大きな設計変更が必要な場合は修正せずユーザーに報告する
- ハーネスが存在しないプロジェクトでは `/harness-init` を案内する
