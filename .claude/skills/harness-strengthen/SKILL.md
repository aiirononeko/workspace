---
name: harness-strengthen
description: |
  失敗やエージェントの誤りをシグナルとして、ハーネスを恒久的に強化する。
  CLAUDE.mdへのルール追記、テストケース追加、構造チェック強化などを行う。
  トリガー: "harness-strengthen", "ハーネス強化", "ハーネス改善", "ハーネスに反映"
user-invocable: true
allowed-tools: Bash, Read, Edit, Write, Glob, Grep, Task
---

# ハーネス強化

失敗やエージェントの誤りをシグナルとして捉え、ハーネスを恒久的に強化するスキル。
「同じ間違いを二度としない」ための仕組みをシステムに組み込む。

## 処理フロー

### Step 1: 対象プロジェクトの特定

引数で指定されていればそれを使う。なければ質問する。
ハーネスファイルの存在を確認する:

```bash
ls <project_dir>/scripts/smoke-test.sh <project_dir>/scripts/structure-check.sh <project_dir>/docs/harness-log.md
```

存在しない場合は `/harness-init` の実行を案内して終了する。

### Step 2: 失敗内容のヒアリング

ユーザーから以下を聞き取る:

```
ハーネスに反映したい内容を教えてください:

1. **何が起きたか**: エージェントの誤り、テスト失敗、発見したバグなど
2. **どこで起きたか**: ファイル名、機能名など（わかれば）
3. **今後どうあるべきか**: 期待する振る舞い

例:
- 「エージェントがUIコンポーネントからDBに直接アクセスするコードを書いた」
- 「ビルドは通るがランタイムエラーになるケースがあった」
- 「特定のAPIエンドポイントのレスポンス形式が仕様と違っていた」
```

### Step 3: 原因の分類

ヒアリング内容から、強化すべき対象を分類する:

| 原因分類 | 説明 | 対策先 |
|---------|------|--------|
| **コンテキスト不足** | エージェントがルールを知らなかった | CLAUDE.md にルール追記 |
| **テスト不足** | チェックすべきケースがなかった | smoke-test.sh にテスト追加 |
| **構造違反** | アーキテクチャ境界を越えた | structure-check.sh にチェック追加 |
| **ツール不足** | 既存スクリプトでは検証できない | 新しい検証スクリプトを作成 |

複数の分類に該当する場合は、すべてに対策を講じる。

### Step 4: Codexと相談（オプション）

必要に応じてCodex CLIで最適な強化策を相談する:

```bash
codex exec --full-auto --sandbox read-only --cd <project_dir> \
  "以下の問題に対するハーネス強化策を提案してください:

   問題: <ヒアリング内容>
   現在のハーネス:
   - CLAUDE.md の DoD
   - smoke-test.sh
   - structure-check.sh

   以下の観点で具体的なコード・ルールを提案してください:
   1. CLAUDE.md に追記すべきルール
   2. smoke-test.sh に追加すべきテストケース
   3. structure-check.sh に追加すべきチェック
   4. 新たに必要な検証スクリプト（あれば）

   確認や質問は不要です。具体的なコード例まで自主的に出力してください。"
```

### Step 5: ハーネス更新

分類に応じてファイルを更新する。

#### コンテキスト不足 → CLAUDE.md 更新

```markdown
## 禁止事項（追記）

- <新しいルール>
```

追記位置はDoDセクションまたは禁止事項セクションの末尾。

#### テスト不足 → smoke-test.sh 更新

既存のテストセクションに新しいテストケースを追加:

```bash
# --- 追加テスト: <テスト名> ---
echo "🆕 <カテゴリ>"
run_test "<テスト名>" <test_command>
```

#### 構造違反 → structure-check.sh 更新

既存のチェックセクションに新しいチェックを追加:

```bash
# --- 追加チェック: <チェック名> ---
check "<チェック名>" <check_command>
```

#### ツール不足 → 新スクリプト作成

`scripts/` に新しい検証スクリプトを作成し、smoke-test.sh から呼び出すように連携する。

### Step 6: harness-log.md に履歴記録

`docs/harness-log.md` の履歴テーブルに行を追加:

```markdown
| <today> | <分類> | <何が起きたか> | <何を追加・変更したか> |
```

### Step 7: 動作確認

強化後のハーネスを実行して確認:

```bash
cd <project_dir> && ./scripts/smoke-test.sh && ./scripts/structure-check.sh
```

### Step 8: 結果報告

```
## 🔧 ハーネス強化完了

### 原因分類
<コンテキスト不足 / テスト不足 / 構造違反 / ツール不足>

### 変更内容
- 📋 CLAUDE.md: <追記したルール>
- 🔥 smoke-test.sh: <追加したテスト>
- 🏗️ structure-check.sh: <追加したチェック>
- 🆕 scripts/xxx.sh: <新規作成したスクリプト>

### 動作確認結果
<ハーネス実行結果>

### 強化履歴
docs/harness-log.md に記録済み
```

## 設計原則

- **失敗はシグナル**: 失敗を責めるのではなく、ハーネス強化の材料として活用する
- **恒久的な対策**: 一時的なワークアラウンドではなく、二度と同じ問題が起きない仕組みを作る
- **段階的に育てる**: 一度に大量のルールを追加しない。1つの問題に1つの対策
- **ハーネスのハーネス**: ハーネス自体もCodexに作らせる（naoya_ito式）
